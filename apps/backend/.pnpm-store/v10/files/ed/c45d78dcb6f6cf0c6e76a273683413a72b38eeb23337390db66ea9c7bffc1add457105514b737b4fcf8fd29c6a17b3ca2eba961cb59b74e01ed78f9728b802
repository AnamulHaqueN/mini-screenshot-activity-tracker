{"version":3,"sources":["../../providers/session_provider.ts"],"sourcesContent":["/*\n * @adonisjs/session\n *\n * (c) AdonisJS\n *\n * For the full copyright and license information, please view the LICENSE\n * file that was distributed with this source code.\n */\n\nimport { configProvider } from '@adonisjs/core'\nimport { RuntimeException } from '@poppinss/utils'\nimport type { ApplicationService } from '@adonisjs/core/types'\n\nimport type { Session } from '../src/session.js'\nimport SessionMiddleware from '../src/session_middleware.js'\nimport { SessionCollection } from '../src/session_collection.js'\n\n/**\n * Events emitted by the session class\n */\ndeclare module '@adonisjs/core/types' {\n  interface EventsList {\n    'session:initiated': { session: Session }\n    'session:committed': { session: Session }\n    'session:migrated': { fromSessionId: string; toSessionId: string; session: Session }\n  }\n}\n\n/**\n * Session provider configures the session management inside an\n * AdonisJS application\n */\nexport default class SessionProvider {\n  constructor(protected app: ApplicationService) {}\n\n  /**\n   * Registers edge plugin when edge is installed\n   * in the user application.\n   */\n  protected async registerEdgePlugin() {\n    if (this.app.usingEdgeJS) {\n      const edge = await import('edge.js')\n      const { edgePluginSession } = await import('../src/plugins/edge.js')\n      edge.default.use(edgePluginSession)\n    }\n  }\n\n  /**\n   * Resolves the session config from the config provider\n   */\n  async #resolveConfig() {\n    const sessionConfigProvider = this.app.config.get('session', {})\n    const config = await configProvider.resolve<any>(this.app, sessionConfigProvider)\n\n    if (!config) {\n      throw new RuntimeException(\n        'Invalid \"config/session.ts\" file. Make sure you are using the \"defineConfig\" method'\n      )\n    }\n\n    return config\n  }\n\n  /**\n   * Registering bindings\n   */\n  register() {\n    this.app.container.singleton(SessionMiddleware, async (resolver) => {\n      const config = await this.#resolveConfig()\n      const emitter = await resolver.make('emitter')\n      return new SessionMiddleware(config, emitter)\n    })\n\n    this.app.container.singleton(SessionCollection, async () => {\n      const config = await this.#resolveConfig()\n      return new SessionCollection(config)\n    })\n  }\n\n  /**\n   * Adding edge tags (if edge is installed)\n   */\n  async boot() {\n    await this.registerEdgePlugin()\n  }\n}\n"],"mappings":";;;;;;;;;;;;AASA,SAAS,sBAAsB;AAC/B,SAAS,wBAAwB;AAsBjC,IAAqB,kBAArB,MAAqC;AAAA,EACnC,YAAsB,KAAyB;AAAzB;AAAA,EAA0B;AAAA;AAAA;AAAA;AAAA;AAAA,EAMhD,MAAgB,qBAAqB;AACnC,QAAI,KAAK,IAAI,aAAa;AACxB,YAAM,OAAO,MAAM,OAAO,SAAS;AACnC,YAAM,EAAE,kBAAkB,IAAI,MAAM,OAAO,wBAAwB;AACnE,WAAK,QAAQ,IAAI,iBAAiB;AAAA,IACpC;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,iBAAiB;AACrB,UAAM,wBAAwB,KAAK,IAAI,OAAO,IAAI,WAAW,CAAC,CAAC;AAC/D,UAAM,SAAS,MAAM,eAAe,QAAa,KAAK,KAAK,qBAAqB;AAEhF,QAAI,CAAC,QAAQ;AACX,YAAM,IAAI;AAAA,QACR;AAAA,MACF;AAAA,IACF;AAEA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,WAAW;AACT,SAAK,IAAI,UAAU,UAAU,mBAAmB,OAAO,aAAa;AAClE,YAAM,SAAS,MAAM,KAAK,eAAe;AACzC,YAAM,UAAU,MAAM,SAAS,KAAK,SAAS;AAC7C,aAAO,IAAI,kBAAkB,QAAQ,OAAO;AAAA,IAC9C,CAAC;AAED,SAAK,IAAI,UAAU,UAAU,mBAAmB,YAAY;AAC1D,YAAM,SAAS,MAAM,KAAK,eAAe;AACzC,aAAO,IAAI,kBAAkB,MAAM;AAAA,IACrC,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,OAAO;AACX,UAAM,KAAK,mBAAmB;AAAA,EAChC;AACF;","names":[]}