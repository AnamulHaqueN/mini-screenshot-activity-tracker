services:
   # MySQL Database for Development
   mysql:
      image: mysql:8.0
      restart: unless-stopped
      environment:
         MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-root}
         MYSQL_DATABASE: ${DB_DATABASE:-app}
      ports:
         - '3307:3306'
         - '3307:3306'
      volumes:
         - mysql_data_dev:/var/lib/mysql
      networks:
         - backend-network
      command: --default-authentication-plugin=mysql_native_password
      healthcheck:
         test:
            ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'root', '-p${DB_PASSWORD:-root}']
         interval: 10s
         timeout: 5s
         retries: 5

   # Backend Application (Development with Hot Reload)
   backend:
      image: node:20-alpine
      restart: unless-stopped
      working_dir: /app
      command: sh -c "apk add --no-cache netcat-openbsd && corepack enable && corepack prepare pnpm@10.25.0 --activate && pnpm install && echo 'Waiting for MySQL to be ready...' && while ! nc -z mysql 3306; do echo 'MySQL is unavailable - sleeping'; sleep 2; done && echo 'MySQL is up - executing migrations' && node ace migration:run && pnpm run dev"
      ports:
         - '${PORT:-3333}:3333'
      environment:
         TZ: ${TZ:-UTC}
         PORT: ${PORT:-3333}
         HOST: 0.0.0.0
         LOG_LEVEL: ${LOG_LEVEL:-debug}
         APP_KEY: ${APP_KEY}
         NODE_ENV: development
         DB_HOST: mysql
         DB_PORT: 3306
         DB_USER: ${DB_USER:-root}
         DB_PASSWORD: ${DB_PASSWORD:-root}
         DB_DATABASE: ${DB_DATABASE:-app}
         CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
         CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
         CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
         SESSION_DRIVER: ${SESSION_DRIVER}
         SESSION_MAX_AGE: ${SESSION_MAX_AGE}
      depends_on:
         mysql:
            condition: service_healthy
      networks:
         - backend-network
      volumes:
         - .:/app
         - /app/node_modules
         - ./logs:/app/logs

networks:
   backend-network:
      driver: bridge

volumes:
   mysql_data_dev:
      driver: local
